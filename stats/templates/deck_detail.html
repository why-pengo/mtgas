{% extends "base.html" %}

{% block title %}{{ deck.name }} - MTG Arena Stats{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'stats:decks' %}">Decks</a></li>
        <li class="breadcrumb-item active">{{ deck.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ deck.name }}</h1>
    <div class="d-flex gap-2">
        {% if unknown_cards_count > 0 %}
        <a href="{% url 'stats:unknown_cards_list' %}?deck_id={{ deck.id }}" 
           class="btn btn-warning"
           title="{{ unknown_cards_count }} unknown card(s) in this deck">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
              <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
            </svg>
            Fix {{ unknown_cards_count }} Unknown Card{{ unknown_cards_count|pluralize }}
        </a>
        {% endif %}
        <a href="{% url 'stats:deck_gallery' deck.id %}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-images" viewBox="0 0 16 16">
              <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
              <path d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2zM14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1zM2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1h-10z"/>
            </svg>
            View Gallery
        </a>
    </div>
</div>

<div class="row">
    <!-- Stats Overview -->
    <div class="col-md-8 mb-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ stats.games }}</div>
                    <div class="stat-label">Games</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ stats.wins }}</div>
                    <div class="stat-label">Wins</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ stats.win_rate }}%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">{{ stats.avg_turns|floatformat:1|default:"-" }}</div>
                    <div class="stat-label">Avg Turns</div>
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="stat-value">
                        {{ land_pct }}%
                    </div>
                    <div class="stat-label">Lands
                        <button type="button" class="btn btn-link btn-sm p-0 ms-1 align-baseline text-muted"
                                data-bs-toggle="popover"
                                data-bs-trigger="focus"
                                data-bs-placement="top"
                                data-bs-html="true"
                                data-bs-title="Land Ratio"
                                data-bs-content="<p class='mb-1'><strong>This deck:</strong> {{ total_lands }} lands / {{ total_cards }} cards ({{ land_pct }}%)</p><p class='mb-1'><strong>Suggested:</strong> {{ suggested_lands }} lands for a {{ total_cards }}-card deck</p><hr class='my-1'><p class='mb-1'>The standard rule of thumb is <strong>17 lands in a 40-card Limited deck</strong> (42.5%). This scales linearly — a 60-card deck typically runs 25–26 lands.</p><p class='mb-0 text-muted small'>Too few lands = mana screw. Too many = mana flood. Adjust based on your curve: higher average CMC warrants more lands.</p>"
                                aria-label="Land ratio info">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mana Curve -->
        <div class="card mb-4">
            <div class="card-header">Mana Curve</div>
            <div class="card-body">
                <div id="manaCurveChart"></div>
            </div>
        </div>

        <!-- Color Distribution -->
        {% if color_counts %}
        <div class="card mb-4">
            <div class="card-header">Color Distribution</div>
            <div class="card-body">
                <div id="colorDistChart"></div>
            </div>
        </div>
        {% endif %}

        <!-- Matchups -->
        {% if matchups %}
        <div class="card">
            <div class="card-header">Opponent Matchups</div>
            <div class="card-body">
                <div id="matchupsChart"></div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Deck List -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                Deck List
                <span class="badge bg-secondary float-end">{{ deck.format|default:"Unknown" }}</span>
                <span class="badge bg-primary float-end me-1">{{ total_cards }} cards</span>
            </div>
            <div class="card-body">
                {% for category, cards in cards_by_type.items %}
                <h6 class="mt-3">{{ category }} ({{ cards|length }})</h6>
                {% for item in cards %}
                <div class="small">
                    {{ item.quantity }}x
                    {% if item.card.name %}
                    {% if item.card.name|slice:":12" == "Unknown Card" %}
                    <a href="{% url 'stats:unknown_card_fix' item.card.grp_id %}"
                       class="card-link text-warning">{{ item.card.name }}</a>
                    {% else %}
                    <a href="https://scryfall.com/search?q=!%22{{ item.card.name|urlencode }}%22" target="_blank" rel="noopener"
                       class="card-link"
                       data-card-image="/static/card_images/{{ item.card.grp_id }}.jpg"
                       data-card-fallback="{{ item.card.image_uri|default:'' }}">{{ item.card.name }}</a>
                    {% endif %}
                    {% else %}
                    Unknown
                    {% endif %}
                    <span class="text-muted">{{ item.card.mana_cost }}</span>
                </div>
                {% endfor %}
                {% empty %}
                <p class="text-muted">No card data available</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize popovers
    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => {
        new bootstrap.Popover(el);
    });

    // Mana Curve
    const manaCurve = {{ mana_curve|safe }};
    MTGACharts.manaCurveChart('#manaCurveChart', manaCurve);

    // Color Distribution
    const colorCounts = {{ color_counts|safe }};
    if (Object.keys(colorCounts).length > 0) {
        MTGACharts.colorDistributionChart('#colorDistChart', colorCounts);
    }

    // Matchups Win Rate
    const matchups = [
        {% for m in matchups %}
        {label: "{{ m.opponent_name|escapejs }}", wins: {{ m.wins }}, losses: {{ m.games }} - {{ m.wins }}, games: {{ m.games }}},
        {% endfor %}
    ];
    if (matchups.length > 0) {
        MTGACharts.winRateBarChart('#matchupsChart', matchups);
    }
});
</script>
{% endblock %}
